var config = require('../common/app-config').config;
var util = require('../common/CommonUtil');
var greetingMessageFilter = require('./MessageFilter/GreetingMessage');
var foodFirstMessageFilter = require('./MessageFilter/FoodFirstMessage');
var unknownMessageFilter = require('./MessageFilter/UnknownMessage');
var locationFirstMessageFilter = require('./MessageFilter/LocationFirstMessage');

module.exports = createMessageHandler;

function MessagekHandler(user, userMappingObject) {
    this.user = user;
    this.userMappingObj = userMappingObject || {};
}

function createMessageHandler(user, userMappingObject) {
    if (!util.isDefined(user)) {
        return new Error('Lack of user ');
    }

    if (!util.isDefined(userMappingObject)) {
        return new Error('Lack of userMappingObject ');
    }

    return new MessagekHandler(user, userMappingObject);
}

MessagekHandler.prototype.doDispatchingMessage = function (response) {
    return doDispathchingMesssage(response, this.user);
}

function doDispathchingMesssage(response, user) {
    console.log(response);
    user.setResponseAPI(response);
    var intentName = response.result.metadata.intentName;
    if (response.status.code === 200) {
        if (intentName.indexOf(config.INPUT_INTENT_GREETING) > -1) {
            user.setStatusCode(200);
            return greetingMessageFilter.getCurrentSenderInformation(user);
        }

        if (intentName.indexOf(config.INPUT_INTENT_FOOD_FIRST) > -1) {
            user.setStatusCode(200);
            var foodFirstMessageFiterObject = foodFirstMessageFilter(user);
            return foodFirstMessageFiterObject.handleWordProcessingFoodFirst(response);
        }

        if (intentName.indexOf(config.INPUT_INTENT_UNKNOWN) > -1) {
            user.setStatusCode(300);
            var unknownMessageFilterObject = unknownMessageFilter(user);
            return unknownMessageFilterObject.handleUnknownMessage(response);
        }

        if (intentName.indexOf(config.INPUT_INTENT_LOCATION_FIRST) > -1) {
            user.setStatusCode(200);
            var unknownMessageFilterObject = locationFirstMessageFilter(user);
            return unknownMessageFilterObject.handleWordProcessingLocationFirst(response);
        }
    }

}
